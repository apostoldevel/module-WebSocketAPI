WebSocket API
-
**Модуль** для [Апостол](https://github.com/ufocomp/apostol-aws).

Описание
-
* **WebSocket API** предоставляет возможность подключения к API системы по протоколу [WebSocket](https://ru.wikipedia.org/wiki/WebSocket).

Установка
-
Следуйте указаниям по сборке и установке [Апостол](https://github.com/ufocomp/apostol-aws#%D1%81%D0%B1%D0%BE%D1%80%D0%BA%D0%B0-%D0%B8-%D1%83%D1%81%D1%82%D0%B0%D0%BD%D0%BE%D0%B2%D0%BA%D0%B0)

Описание
-

## Запрос клиента

Чтобы установить с сервером соединение WebSocket, клиентское приложение должно выполнить «Рукопожатие» («Opening Handshake»), как описано в [RFC6455](https://tools.ietf.org/html/rfc6455) [раздел 4](https://tools.ietf.org/html/rfc6455#section-4).

Сервер накладывает дополнительные ограничения на URL-адрес и подпротокол WebSocket, подробно описанные ниже.

### URL подключения

Чтобы инициировать соединение WebSocket, клиенту требуется URL-адрес [RFC3986](https://tools.ietf.org/html/rfc3986) для подключения (URL подключения).

[Взаимодействие с системой](https://github.com/ufocomp/module-AppServer#%D0%B4%D0%BE%D1%81%D1%82%D1%83%D0%BF-%D0%BA-api) происходит в рамках ранее созданной сессии. Сессия создается после успешной аутентификации пользователя в системе. Результатом которой является получение маркера доступа, идентификатора сессии и секретного ключа.

URL подключения содержит в себе код сессии к которой происходит подключение.

Окончательный URL подключения выглядит так:
````
wss://ws.exemple.com/session/<code>
````
* Где:
  `<code>` - Код сессии (40 символов).

Пример:
````
wss://ws.exemple.com/session/c83b2f85321f95341707624546ca6ac4fa6d1115
````

## RPC framework

Протокол WebSocket сам по себе не дает возможности отправлять сообщения в режиме запрос/ответ. Чтобы обеспечить эту возможность был создан небольшой RPC протокол поверх WebSocket в формате JSON.

### Описание JSON ключей

Ключ | Расшифровка | Тип данных | Назначение, примечания
----- | ----------- | ---------- | ----------------------
t | MessageTypeId | INTEGER | Тип сообщения. Описание ниже.
u | UniqueId | UUID | Уникальный идентификатор сообщения. Если сообщение от сервера является ответом на запрос от клиента, то UniqueId будет одинаковым.
a | Action | STRING | Действие (маршрут к конечной точке API).
c | ErrorCode | INTEGER | Код ошибки.
m | ErrorMessage | STRING |  Сообщение об ошибке.
p | Payload | JSON | Полезная нагрузка.

### Тип сообщения (MessageTypeId):

Тип сообщения | Номер типа сообщения | Направление | Описание
----- | ----------- | ---------- | ----------------------
OPEN | 0 | Клиент-Сервер | Авторизация. Открытие ранее созданной сессии.
CLOSE | 1 | Клиент-Сервер | Закрытие сессии (выход из системы).
CALL | 2 | Клиент-Сервер | Запрос.
CALLRESULT | 3 | Сервер-Клиент | Ответ на запрос.
CALLERROR | 4 | Сервер-Клиент | Ответ на запрос с ошибкой.

## Авторизация

* После подключения клиенты нужно авторизоваться.

Авторизация может быть выполнена в автоматическом режиме при условии, если в момент установки связи были указаны соответствующие HTTP-заголовки:

- `Authorization: Bearer <token>`

Или:

- `Session: <session>`
- `Secret: <secret>`

Если заполнение HTTP-заголовков блокируется на стороне используемого, клиентским приложением, фрейворком, то авторизация выполняется путем отправки пакета `OPEN` с данными авторизации (которые выдал [сервер авторизации](https://github.com/ufocomp/module-AuthServer)) это может быть или маркер доступа (`token`) или секретный код сессии `secret`.

После успешной авторизации Вы сможете отправлять API запросы с типом сообщения `CALL`. Где маршрут к конечной точке API указывается в ключе `Action`, а JSON тело запроса в ключе `Payload`.

Попытка отправить запрос до выполнения успешной процедуры авторизации приведет к ответу с типом сообщения `CALLERROR`:

**Пример:**

Если код сессии указан не верно или сессия была закрыта то ответ будет с типом сообщения `CALLERROR`:
````json
{"t":4,"u":"<uuid>","c":400,"m":"Код сессии не найден."}
````

Авторизация по секретному коду сессии:
````json
{"t":0,"u":"<uuid>","p":{"secret": "MWCJ14k/RJyiHskQB8DoVbliiwDeNGKsgsAMugp3OZt+M0Zj44hDykwRuFoWEwuG"}}
````

Положительный ответ:
````json
{"t":3,"u":"<uuid>","p":{"authorized": true, "code": "amAJmzkxvDE+ad7KwkRtZU1qkUod+3XuycBbxRqHOOjBdeOkkR+lSExI4L8LAcb+", "message": "Успешно."}}
````
* Где:
  `code` - Новый [код авторизации](https://github.com/ufocomp/module-AuthServer#%D0%BA%D0%BE%D0%B4-%D0%B0%D0%B2%D1%82%D0%BE%D1%80%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D0%B8) на получение маркера доступа (не путать с секретным кодом сессии).

Отрицательный ответ:
````json
{"t":4,"u":"<uuid>","c":401,"m":"Выход из системы. Секретный код сессии не прошёл проверку."}
````
**ВНИМАНИЕ**: При передаче неверных данных авторизации сессия будет закрыта, но не соединение.

Авторизация по маркеру доступа:
````json
{"t":0,"u":"<uuid>","p":{"token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiIDogImFjY291bnRzLnBsdWdtZS5ydSIsICJhdWQiIDogInNlcnZpY2UtcGx1Z21lLnJ1IiwgInN1YiIgOiAiYzgzYjJmODUzMjFmOTUzNDE3MDc2MjQ1NDZjYTZhYzRmYTZkMTExNSIsICJpYXQiIDogMTYwNjIxMDcwNiwgImV4cCIgOiAxNjA2MjE0MzA2fQ.ZI82FKXAgA1CZm3gx9XCpgpq_WyZJvwqYI4nOdccVts"}}
````
**ВНИМАНИЕ**: Не забывайте, что маркер доступа имеет ограниченный срок жизни.

Положительный ответ:
````json
{"t":3,"u":"<uuid>","p":{"authorized": true, "message": "Успешно."}}
````

Отрицательный ответ:
````json
{"t":4,"u":"<uuid>","c":403,"m":"Verification failed: Token expired."}
````

## Подписка на события

* Для того чтобы получать данные от сервера без предварительных запросов со стороны клиентского приложения нужно подписаться на события.


* Для того чтобы подписаться на события нужно выбрать _издателя_ и настроить _слушателя_.

## Наблюдатель (`obsesver`)

### Конечные точки наблюдателя

#### Подписаться

```http request
POST /api/v1/obsesver/subscribe
```
Подписаться на события издателя.

**Параметры запроса:**

Поле | Тип | Значение | Описание
------------ | ------------ | ------------ |------------
code | STRING | notify | **Обязательный**. Код издателя.
filter | JSON |  | **Необязательный**. Фильтр отбора событий издателя.
params | JSON |  | **Необязательный**. Параметры слушателя.

Примеры запроса:
````json
{"t":2,"u":"<uuid>","a":"/observer/subscribe","p":{"code":"notify"}}
````

````json
{"t":2,"u":"<uuid>","a":"/observer/subscribe","p":{"code":"notify","filter":{"classes":["client"]},"params":{"type":"object"}}}
````

````json
{"t":2,"u":"<uuid>","a":"/observer/subscribe","p":{"code":"notify","filter":{"classes":["client"],"actions":["create"]},"params":{"type":"hook","hook":{"path": "/api/v1/client/list", "payload": {}}}}}
````

#### Отписаться

```http request
POST /api/v1/obsesver/unsubscribe
```
Отписаться от событий издателя.

**Параметры запроса:**

Поле | Тип | Значение | Описание
------------ | ------------ | ------------ |------------
code | STRING | notify | **Обязательный**. Код издателя.

Пример запроса:
````json
{"t":2,"u":"<uuid>","a":"/observer/unsubscribe","p":{"code":"notify"}}
````

## Издатель (`publisher`)

### Уведомления (`notify`)

Издатель `notify` предоставляет возможность подписаться на системные события, которые возникают каждый раз, когда пользователь системы взаимодействует с тем или иным объектом.

#### Фильтр

Представление JSON для фильтра отбора событий:

```json
{
  "entities": enum (string),
  "classes": enum (string),
  "actions": enum (string),
  "methods": enum (string),
  "objects": enum (numeric)
}
```

Поле | Тип | Значение | Описание
------------ | ------------ | ------------ |------------
entities | JSON array | Коды сущностный | **Необязательный**. Сущности. Массив кодов.
classes  | JSON array | Коды классов | **Необязательный**. Классы. Массив кодов.
actions  | JSON array | Коды событий | **Необязательный**. События. Массив кодов.
methods  | JSON array | Коды методов | **Необязательный**. Методы. Массив кодов.
objects  | JSON array | Объекты | **Необязательный**. Объекты. Массив идентификаторов.

**ВАЖНО**: Фильтр работает по условию `И` (не `ИЛИ`).

**ВАЖНО**: Поля в которых не заданы значения игнорируются при выполнении условий отбора по фильтру.

#### Параметры

Представление JSON параметров:

```json
{
  "type": string,
  "hook": Hook
}
```

Поле | Тип | Значение | Описание
------------ | ------------ | ------------ |------------
type | STRING | notify, object, hook | **Необязательный**. Тип ответа.
hook  | JSON | Hook | **Обязательный** для типа hook. Ловушка.

* Если указать `notify`, то в ответ будут приходить сами уведомления.
* Если указать `object`, то в ответ будут приходить данные объекта в формате /get запроса.
* Если указать `hook`, то ответом будет результат выполнения API запроса из `Hook`.

#### Hook

```json
{
  "method": string,
  "path": string,
  "payload": json
}
```

Поле | Тип | Значение | Описание
------------ | ------------ | ------------ |------------
method | STRING | POST, GET | **Необязательный**. HTTP-метод.
path  | STRING | | **Обязательный**. REST API путь к конечной точке.
payload  | JSON | Hook | **Вариативный**. Полезная нагрузка. Зависит от запроса.

### Конечные точки издателя

```http request
POST /api/v1/obsesver/publisher
```
Получить данные издателя по коду.

**Параметры запроса:**

Поле | Тип | Значение | Описание
------------ | ------------ | ------------ |------------
code | STRING | notify | **Обязательный**. Код издателя.
fields | JSON array |  | **Необязательный**. Массив JSON string полей в таблице, если не указано то запрос вернет все поля.

### Данные издателя

```http request
POST /api/v1/obsesver/publisher/get
```
Получить данные издателя по идентификатору.

**Параметры запроса:**

Поле | Тип | Значение | Описание
------------ | ------------ | ------------ |------------
id | NUMERIC |  | **Обязательный**. Идентификатор издателя.
fields | JSON array |  | **Необязательный**. Массив JSON string полей в таблице, если не указано то запрос вернет все поля.

### Количество издателей

```http request
POST /api/v1/obsesver/publisher/count
```
Количество издателей с возможностью указания фильтра отбора данных.

**Параметры запроса:**
[Общие параметры запроса для списка](https://github.com/ufocomp/db-platform#%D0%BE%D0%B1%D1%89%D0%B8%D0%B5-%D0%BF%D0%B0%D1%80%D0%B0%D0%BC%D0%B5%D1%82%D1%80%D1%8B-%D0%B7%D0%B0%D0%BF%D1%80%D0%BE%D1%81%D0%B0-%D0%B4%D0%BB%D1%8F-%D1%81%D0%BF%D0%B8%D1%81%D0%BA%D0%B0)

### Список издателей
```http request
POST /api/v1/obsesver/publisher/list
```
Список издателей с возможностью указания фильтра отбора.

**Параметры запроса:**
[Общие параметры запроса для списка](https://github.com/ufocomp/db-platform#%D0%BE%D0%B1%D1%89%D0%B8%D0%B5-%D0%BF%D0%B0%D1%80%D0%B0%D0%BC%D0%B5%D1%82%D1%80%D1%8B-%D0%B7%D0%B0%D0%BF%D1%80%D0%BE%D1%81%D0%B0-%D0%B4%D0%BB%D1%8F-%D1%81%D0%BF%D0%B8%D1%81%D0%BA%D0%B0)

### Слушатель (`listener`)

```http request
POST /api/v1/obsesver/listener
```
Получить данные слушателя по коду издателя.

**Параметры запроса:**

Поле | Тип | Значение | Описание
------------ | ------------ | ------------ |------------
code | STRING | notify | **Обязательный**. Код издателя.
session | STRING |  | **Необязательный**. Код сессии.
fields | JSON array |  | **Необязательный**. Массив JSON string полей в таблице, если не указано то запрос вернет все поля.

### Установить слушателя

```http request
POST /api/v1/obsesver/listener/set
```
Установить данные слушателя.

**Параметры запроса:**

Поле | Тип | Значение | Описание
------------ | ------------ | ------------ |------------
publisher | NUMERIC |  | **Обязательный**. Идентификатор издателя.
session | STRING |  | **Необязательный**. Код сессии.
filter | JSON |  | **Необязательный**. Фильтр отбора событий издателя.
params | JSON |  | **Необязательный**. Параметры слушателя.

### Данные слушателя

```http request
POST /api/v1/obsesver/listener/get
```
Получить данные слушателя.

**Параметры запроса:**

Поле | Тип | Значение | Описание
------------ | ------------ | ------------ |------------
publisher | NUMERIC |  | **Обязательный**. Идентификатор издателя.
session | STRING |  | **Необязательный**. Код сессии.
fields | JSON array |  | **Необязательный**. Массив JSON string полей в таблице, если не указано то запрос вернет все поля.

### Количество слушателей

```http request
POST /api/v1/obsesver/listener/count
```
Количество слушателей с возможностью указания фильтра отбора данных.

**Параметры запроса:**
[Общие параметры запроса для списка](https://github.com/ufocomp/db-platform#%D0%BE%D0%B1%D1%89%D0%B8%D0%B5-%D0%BF%D0%B0%D1%80%D0%B0%D0%BC%D0%B5%D1%82%D1%80%D1%8B-%D0%B7%D0%B0%D0%BF%D1%80%D0%BE%D1%81%D0%B0-%D0%B4%D0%BB%D1%8F-%D1%81%D0%BF%D0%B8%D1%81%D0%BA%D0%B0)

### Список слушателей
```http request
POST /api/v1/obsesver/listener/list
```
Список слушателей с возможностью указания фильтра отбора.

**Параметры запроса:**
[Общие параметры запроса для списка](https://github.com/ufocomp/db-platform#%D0%BE%D0%B1%D1%89%D0%B8%D0%B5-%D0%BF%D0%B0%D1%80%D0%B0%D0%BC%D0%B5%D1%82%D1%80%D1%8B-%D0%B7%D0%B0%D0%BF%D1%80%D0%BE%D1%81%D0%B0-%D0%B4%D0%BB%D1%8F-%D1%81%D0%BF%D0%B8%D1%81%D0%BA%D0%B0)

#### Примеры

Запрос:
````json
{"t":2,"u":"<uuid>","a":"/whoami"}
````

Сущности:
````json
{"t":2,"u":"<uuid>","a":"/entity","p":{"fields": ["id", "code", "name"]}}
````

Классы:
````json
{"t":2,"u":"<uuid>","a":"/class","p":{"fields": ["id", "entity", "entitycode", "entityname", "code", "label"]}}
````

Действия:
````json
{"t":2,"u":"<uuid>","a":"/action","p":{"fields": ["id", "code", "name"]}}
````

Методы:
````json
{"t":2,"u":"<uuid>","a":"/method","p":{"fields": ["id", "class", "classcode", "classlabel", "action", "actioncode", "actionname", "code", "label"]}}
````